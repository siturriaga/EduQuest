<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>CIVITAS - Educational Platform</title>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #0a0a1a 100%);
      min-height: 100vh;
      color: #fff;
    }
    
    .container {
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    
    .title {
      font-size: 2.5rem;
      font-weight: 900;
      text-align: center;
      background: linear-gradient(135deg, #6366f1, #22d3ee, #f472b6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
    }
    
    .subtitle {
      text-align: center;
      color: #888;
      margin-bottom: 2rem;
    }
    
    .card {
      background: rgba(30, 30, 50, 0.95);
      border: 2px solid #333;
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 1rem;
    }
    
    .card h2 {
      text-align: center;
      margin-bottom: 1rem;
      font-size: 1.3rem;
    }
    
    .btn-group {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1.2rem 1.5rem;
      background: #1e1e3a;
      border: 2px solid #6366f1;
      border-radius: 1rem;
      cursor: pointer;
      color: #fff;
      font-family: inherit;
      min-width: 140px;
      transition: all 0.3s;
    }
    
    .btn:hover {
      transform: translateY(-3px);
      border-color: #22d3ee;
      box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
    }
    
    .btn-icon { font-size: 2rem; margin-bottom: 0.3rem; }
    .btn-title { font-weight: 700; }
    .btn-desc { color: #888; font-size: 0.75rem; margin-top: 0.2rem; }
    
    .btn-primary {
      width: 100%;
      padding: 1rem;
      background: linear-gradient(135deg, #6366f1, #4f46e5);
      border: none;
      border-radius: 0.5rem;
      color: #fff;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
    }
    
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-primary.green {
      background: linear-gradient(135deg, #22c55e, #16a34a);
    }
    
    .btn-secondary {
      background: transparent;
      border: 2px solid #444;
      color: #888;
      padding: 0.8rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-family: inherit;
      width: 100%;
      margin-top: 0.5rem;
    }
    
    .btn-secondary:hover {
      border-color: #6366f1;
      color: #fff;
    }
    
    .input {
      width: 100%;
      padding: 0.8rem;
      background: #0a0a1a;
      border: 2px solid #333;
      border-radius: 0.5rem;
      color: #fff;
      font-size: 1rem;
      margin-bottom: 0.8rem;
    }
    
    .input:focus {
      outline: none;
      border-color: #6366f1;
    }
    
    .code-display {
      font-size: 2.5rem;
      font-weight: bold;
      text-align: center;
      letter-spacing: 0.5rem;
      color: #6366f1;
      padding: 1rem;
      background: #0a0a1a;
      border-radius: 0.5rem;
      margin: 1rem 0;
      font-family: monospace;
    }
    
    .code-input-row {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      margin: 1rem 0;
    }
    
    .code-digit {
      width: 45px;
      height: 55px;
      background: #0a0a1a;
      border: 2px solid #333;
      border-radius: 0.5rem;
      font-size: 1.5rem;
      font-weight: bold;
      text-align: center;
      color: #fff;
    }
    
    .code-digit:focus {
      outline: none;
      border-color: #6366f1;
    }
    
    .status {
      text-align: center;
      padding: 0.5rem;
      border-radius: 0.5rem;
      margin: 0.5rem 0;
      font-weight: 600;
    }
    
    .status.connecting { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
    .status.connected { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
    .status.error { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .status.waiting { background: rgba(99, 102, 241, 0.2); color: #a5b4fc; }
    
    .student-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 0.5rem;
      margin: 1rem 0;
      max-height: 150px;
      overflow-y: auto;
    }
    
    .student-tag {
      background: #1e1e3a;
      padding: 0.5rem;
      border-radius: 0.5rem;
      text-align: center;
      font-size: 0.8rem;
    }
    
    .screen { display: none; }
    .screen.active { display: block; }
    
    .link-text {
      color: #6366f1;
      text-align: center;
      margin-top: 1rem;
      cursor: pointer;
    }
    
    .link-text:hover { text-decoration: underline; }
    
    .notice {
      font-size: 0.75rem;
      color: #666;
      text-align: center;
      margin-top: 0.5rem;
      padding: 0.5rem;
      background: rgba(99, 102, 241, 0.1);
      border-radius: 0.3rem;
    }
    
    .stats-row {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin: 1rem 0;
    }
    
    .stat {
      text-align: center;
    }
    
    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #6366f1;
    }
    
    .stat-label {
      font-size: 0.75rem;
      color: #888;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .pulse { animation: pulse 2s infinite; }
  </style>
</head>
<body>

<div class="container">
  
  <!-- SCREEN: Entry -->
  <div id="screen-entry" class="screen active">
    <h1 class="title">CIVITAS</h1>
    <p class="subtitle">Florida 7th Grade Civics ‚Ä¢ Educational Platform</p>
    
    <div class="card">
      <div class="btn-group">
        <button class="btn" onclick="showScreen('teacher-login')">
          <span class="btn-icon">üë®‚Äçüè´</span>
          <span class="btn-title">TEACHER</span>
          <span class="btn-desc">Create session</span>
        </button>
        <button class="btn" onclick="showScreen('student-join')">
          <span class="btn-icon">üéì</span>
          <span class="btn-title">STUDENT</span>
          <span class="btn-desc">Join with code</span>
        </button>
      </div>
    </div>
    
    <p class="link-text" onclick="startSoloGame()">Play solo without session ‚Üí</p>
  </div>
  
  <!-- SCREEN: Teacher Login -->
  <div id="screen-teacher-login" class="screen">
    <div class="card">
      <h2>üë®‚Äçüè´ Teacher Login</h2>
      <input type="email" id="teacher-email" class="input" placeholder="Enter your email">
      <button class="btn-primary" onclick="teacherLogin()">Create Session</button>
      <p class="notice">Authorized: @dadeschools.net or synapsecopilot@gmail.com</p>
      <button class="btn-secondary" onclick="showScreen('entry')">‚Üê Back</button>
    </div>
  </div>
  
  <!-- SCREEN: Teacher Dashboard -->
  <div id="screen-teacher-dashboard" class="screen">
    <div class="card">
      <h2>üìã Session Active</h2>
      
      <p style="text-align:center;color:#888;">Share this code with students:</p>
      <div class="code-display" id="session-code">------</div>
      
      <button class="btn-primary" onclick="copyStudentLink()">üìã Copy Student Link</button>
      
      <div class="stats-row">
        <div class="stat">
          <div class="stat-value" id="student-count">0</div>
          <div class="stat-label">Students</div>
        </div>
      </div>
      
      <div class="student-grid" id="student-list">
        <p style="color:#555;grid-column:1/-1;text-align:center;">Waiting for students...</p>
      </div>
      
      <div class="status connected" id="teacher-status">‚úì Session Active</div>
      
      <button class="btn-primary green" onclick="startClassGame()" style="margin-top:1rem;">‚ñ∂Ô∏è START GAME</button>
      
      <button class="btn-secondary" onclick="endSession()">End Session</button>
    </div>
  </div>
  
  <!-- SCREEN: Student Join -->
  <div id="screen-student-join" class="screen">
    <div class="card">
      <h2>üéì Join Session</h2>
      <p style="text-align:center;color:#888;margin-bottom:0.5rem;">Enter 6-digit code from teacher:</p>
      
      <div class="code-input-row">
        <input type="text" class="code-digit" maxlength="1" data-index="0">
        <input type="text" class="code-digit" maxlength="1" data-index="1">
        <input type="text" class="code-digit" maxlength="1" data-index="2">
        <input type="text" class="code-digit" maxlength="1" data-index="3">
        <input type="text" class="code-digit" maxlength="1" data-index="4">
        <input type="text" class="code-digit" maxlength="1" data-index="5">
      </div>
      
      <div id="join-status" class="status" style="display:none;"></div>
      
      <input type="text" id="student-name" class="input" placeholder="Your FIRST NAME only" maxlength="20">
      
      <button class="btn-primary" id="join-btn" onclick="studentJoin()" disabled>Join Game</button>
      
      <p class="notice">üîí Only your first name is shared. No data stored permanently.</p>
      
      <button class="btn-secondary" onclick="showScreen('entry')">‚Üê Back</button>
    </div>
  </div>
  
  <!-- SCREEN: Student Waiting -->
  <div id="screen-student-waiting" class="screen">
    <div class="card" style="text-align:center;">
      <h2>‚è≥ You're In!</h2>
      <p style="color:#888;">Waiting for teacher to start...</p>
      
      <div class="code-display" id="joined-code">------</div>
      
      <div id="student-status" class="status connected">‚úì Connected</div>
      
      <p class="pulse" style="color:#f59e0b;margin-top:1rem;">Waiting for teacher to start game...</p>
    </div>
  </div>
  
  <!-- SCREEN: Game (placeholder) -->
  <div id="screen-game" class="screen">
    <div class="card" style="text-align:center;">
      <h2>üéÆ Game Started!</h2>
      <p style="color:#22c55e;font-size:1.2rem;margin:2rem 0;">The game is now running.</p>
      <p style="color:#888;">This is where the full game would load.</p>
      <button class="btn-primary" onclick="location.reload()" style="margin-top:2rem;">‚Üê Back to Menu</button>
    </div>
  </div>
  
</div>

<script>
// ==========================================
// FIREBASE CONFIGURATION
// ==========================================
// ‚ö†Ô∏è REPLACE THIS WITH YOUR FIREBASE CONFIG
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

// Initialize Firebase
let db = null;
let isFirebaseReady = false;

try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.database();
  isFirebaseReady = true;
  console.log('‚úì Firebase connected');
} catch(e) {
  console.error('Firebase error:', e);
  alert('Firebase not configured. Please add your Firebase config to the code.');
}

// ==========================================
// SESSION STATE
// ==========================================
const SESSION = {
  code: null,
  isTeacher: false,
  studentName: null
};

// ==========================================
// SCREEN NAVIGATION
// ==========================================
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-' + id).classList.add('active');
}

// ==========================================
// URL AUTO-ROUTING
// ==========================================
function handleAutoRoute() {
  const params = new URLSearchParams(window.location.search);
  const role = params.get('role');
  const code = params.get('code');
  
  if (role === 'student' && code) {
    showScreen('student-join');
    const digits = code.toUpperCase().split('');
    document.querySelectorAll('.code-digit').forEach((input, i) => {
      if (digits[i]) input.value = digits[i];
    });
    setTimeout(validateStudentForm, 100);
  }
}

// ==========================================
// TEACHER FUNCTIONS
// ==========================================
function generateCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = '';
  for (let i = 0; i < 6; i++) {
    code += chars[Math.floor(Math.random() * chars.length)];
  }
  return code;
}

function teacherLogin() {
  const email = document.getElementById('teacher-email').value.trim();
  
  if (!email) {
    alert('Please enter your email');
    return;
  }
  
  const ok = email.endsWith('@dadeschools.net') || 
             email.endsWith('@students.dadeschools.net') || 
             email === 'synapsecopilot@gmail.com';
             
  if (!ok) {
    alert('Access denied. Use an authorized email.');
    return;
  }
  
  if (!isFirebaseReady) {
    alert('Firebase not connected. Check console for errors.');
    return;
  }
  
  SESSION.code = generateCode();
  SESSION.isTeacher = true;
  
  db.ref('sessions/' + SESSION.code).set({
    teacher: email,
    created: Date.now(),
    status: 'waiting',
    students: {}
  }).then(() => {
    document.getElementById('session-code').textContent = SESSION.code;
    showScreen('teacher-dashboard');
    listenForStudents();
  }).catch(err => {
    alert('Error creating session: ' + err.message);
  });
}

function listenForStudents() {
  db.ref('sessions/' + SESSION.code + '/students').on('value', (snapshot) => {
    const students = snapshot.val() || {};
    const names = Object.values(students);
    
    document.getElementById('student-count').textContent = names.length;
    
    const list = document.getElementById('student-list');
    if (names.length === 0) {
      list.innerHTML = '<p style="color:#555;grid-column:1/-1;text-align:center;">Waiting for students...</p>';
    } else {
      list.innerHTML = names.map(s => 
        `<div class="student-tag">${s.name.substring(0,3)}***</div>`
      ).join('');
    }
  });
}

function copyStudentLink() {
  const baseUrl = window.location.origin + window.location.pathname;
  const link = `${baseUrl}?role=student&code=${SESSION.code}`;
  
  navigator.clipboard.writeText(link)
    .then(() => alert('‚úì Student Link Copied!\n\n' + link))
    .catch(() => prompt('Copy this link:', link));
}

function startClassGame() {
  if (!isFirebaseReady) return;
  
  db.ref('sessions/' + SESSION.code + '/status').set('playing');
  showScreen('game');
}

function endSession() {
  if (SESSION.code && isFirebaseReady) {
    db.ref('sessions/' + SESSION.code).remove();
  }
  SESSION.code = null;
  SESSION.isTeacher = false;
  location.reload();
}

// ==========================================
// STUDENT FUNCTIONS
// ==========================================
function getEnteredCode() {
  return [...document.querySelectorAll('.code-digit')]
    .map(i => i.value.toUpperCase())
    .join('');
}

function validateStudentForm() {
  const code = getEnteredCode();
  const name = document.getElementById('student-name').value.trim();
  const btn = document.getElementById('join-btn');
  const status = document.getElementById('join-status');
  
  if (code.length < 6) {
    status.style.display = 'none';
    btn.disabled = true;
    return;
  }
  
  if (!isFirebaseReady) {
    status.textContent = '‚ö† Not connected';
    status.className = 'status error';
    status.style.display = 'block';
    btn.disabled = true;
    return;
  }
  
  db.ref('sessions/' + code).once('value', (snapshot) => {
    if (snapshot.exists()) {
      status.textContent = '‚úì Session found!';
      status.className = 'status connected';
      status.style.display = 'block';
      btn.disabled = name.length < 2;
    } else {
      status.textContent = '‚úó Session not found';
      status.className = 'status error';
      status.style.display = 'block';
      btn.disabled = true;
    }
  });
}

function studentJoin() {
  const code = getEnteredCode();
  const name = document.getElementById('student-name').value.trim();
  
  if (!isFirebaseReady) {
    alert('Cannot connect to server.');
    return;
  }
  
  SESSION.code = code;
  SESSION.studentName = name;
  SESSION.isTeacher = false;
  
  const studentRef = db.ref('sessions/' + code + '/students').push();
  studentRef.set({
    name: name,
    joined: Date.now()
  }).then(() => {
    document.getElementById('joined-code').textContent = code;
    showScreen('student-waiting');
    
    // Listen for game start
    db.ref('sessions/' + code + '/status').on('value', (snapshot) => {
      if (snapshot.val() === 'playing') {
        showScreen('game');
      }
    });
  }).catch(err => {
    alert('Error joining: ' + err.message);
  });
}

// ==========================================
// SOLO MODE
// ==========================================
function startSoloGame() {
  showScreen('game');
}

// ==========================================
// CODE INPUT HANDLING
// ==========================================
document.addEventListener('DOMContentLoaded', () => {
  const digits = document.querySelectorAll('.code-digit');
  
  digits.forEach((input, i) => {
    input.addEventListener('input', () => {
      input.value = input.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
      if (input.value && i < 5) digits[i + 1].focus();
      validateStudentForm();
    });
    
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' && !input.value && i > 0) {
        digits[i - 1].focus();
      }
    });
    
    input.addEventListener('paste', (e) => {
      e.preventDefault();
      const paste = (e.clipboardData || window.clipboardData).getData('text');
      const chars = paste.toUpperCase().replace(/[^A-Z0-9]/g, '').split('');
      digits.forEach((d, j) => { if (chars[j]) d.value = chars[j]; });
      validateStudentForm();
    });
  });
  
  document.getElementById('student-name').addEventListener('input', validateStudentForm);
  
  handleAutoRoute();
});
</script>

</body>
</html>
